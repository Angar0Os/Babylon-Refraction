<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Babylon.js Dynamic Cubemap with HDR</title>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylon.glTF2FileLoader.js"></script>
    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    <script>
        if (BABYLON.Engine.isSupported()) {
            var canvas = document.getElementById("renderCanvas");
            var engine = new BABYLON.Engine(canvas, true);

            var createScene = function () {
                var scene = new BABYLON.Scene(engine);
                scene.debugLayer.show({ embedMode: true });

                var camera = new BABYLON.ArcRotateCamera("Camera", -Math.PI / 4, Math.PI / 2.5, 3, BABYLON.Vector3.Zero(), scene);
                camera.attachControl(canvas, true);
                camera.minZ = 0.1;
                camera.wheelDeltaPercentage = 0.01;

                var light = new BABYLON.PointLight("point", new BABYLON.Vector3(0, 40, 0), scene);

                var hdrTexture = new BABYLON.HDRCubeTexture("textures/room4k.hdr", scene, 512);

                var hdrSkybox = BABYLON.Mesh.CreateBox("hdrSkyBox", 1000.0, scene);
                var hdrSkyboxMaterial = new BABYLON.PBRMaterial("skyBox", scene);
                hdrSkyboxMaterial.backFaceCulling = false;
                hdrSkyboxMaterial.reflectionTexture = hdrTexture.clone();
                hdrSkyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
                hdrSkyboxMaterial.microSurface = 1.0;
                hdrSkyboxMaterial.disableLighting = true;
                hdrSkybox.material = hdrSkyboxMaterial;
                hdrSkybox.infiniteDistance = true;

                var dynamicReflectionTexture = new BABYLON.RenderTargetTexture("tartiflette", { width: 512, height: 512 }, scene, true, true);
                dynamicReflectionTexture.renderList = [hdrSkybox]; 
                dynamicReflectionTexture.refreshRate = BABYLON.RenderTargetTexture.REFRESHRATE_RENDER_ONEVERYFRAME;

                BABYLON.SceneLoader.Append("", "model1.glb", scene, function () {
                    let bottleMesh = scene.getMeshByName("bottle");
                    if (bottleMesh) {
                        var glassMaterial = new BABYLON.PBRMaterial("glassMaterial", scene);
                        glassMaterial.reflectionTexture = dynamicReflectionTexture;
                        glassMaterial.refractionTexture = hdrTexture; 
                        glassMaterial.linkRefractionWithTransparency = true;
                        glassMaterial.indexOfRefraction = 1.3;
                        glassMaterial.alpha = 0;
                        glassMaterial.directIntensity = 0.0;
                        glassMaterial.environmentIntensity = 0.7;
                        glassMaterial.cameraExposure = 0.66;
                        glassMaterial.cameraContrast = 1.66;
                        glassMaterial.microSurface = 1;
                        glassMaterial.reflectivityColor = new BABYLON.Color3(0.2, 0.2, 0.2);
                        glassMaterial.albedoColor = new BABYLON.Color3(0.95, 0.95, 0.95);
                        bottleMesh.material = glassMaterial;

                        dynamicReflectionTexture.renderList.push(...scene.meshes.filter(mesh => mesh !== bottleMesh));
                    }
                });

                return scene;
            };

            var scene = createScene();

            engine.runRenderLoop(function () {
                if (scene) {
                    scene.render();
                }
            });

            window.addEventListener("resize", function () {
                engine.resize();
            });
        }
    </script>
</body>
</html>
